<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>오디오 무음 추가기</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 40px; }
        #status { margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>음악 파일에 1분 무음 추가하기</h1>
    <p>음악 파일을 선택하면 맨 앞에 1분 무음을 추가한 뒤 다운로드 링크가 생성됩니다.</p>
    
    <input type="file" id="uploader">
    <br>
    <p id="status">파일을 선택해주세요.</p>
    <div id="result"></div>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });

        const uploader = document.getElementById('uploader');
        const statusEl = document.getElementById('status');
        const resultEl = document.getElementById('result');

        uploader.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            resultEl.innerHTML = '';
            
            statusEl.textContent = '엔진 로딩 중...';
            if (!ffmpeg.isLoaded()) {
                await ffmpeg.load();
            }
            
            statusEl.textContent = '파일을 메모리에 쓰는 중입니다...';
            const { name } = file;
            const namePart = name.slice(0, name.lastIndexOf('.'));
            const extPart = name.slice(name.lastIndexOf('.'));
            const outputName = `${namePart}_bypass_spotify${extPart}`;

            ffmpeg.FS('writeFile', name, await fetchFile(file));

            statusEl.textContent = '1분 무음을 추가하는 작업을 시작합니다 (조금 걸릴 수 있습니다)...';
            
            await ffmpeg.run(
                '-f', 'lavfi', '-i', 'anullsrc=r=44100:cl=stereo:d=60',
                '-i', name,
                '-filter_complex', '[0:a][1:a]concat=n=2:v=0:a=1',
                outputName
            );

            statusEl.textContent = '작업 완료! 결과 파일을 읽는 중...';
            const data = ffmpeg.FS('readFile', outputName);

            const blob = new Blob([data.buffer], { type: 'audio/mpeg' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = outputName;
            link.textContent = `${outputName} 다운로드`;
            
            resultEl.appendChild(link);
            statusEl.textContent = '다운로드 링크가 생성되었습니다!';
        });
    </script>
</body>
</html>
